---
title: "README"
author: "Victor"
date: "September 14, 2018"
output: md_document
editor_options: 
  chunk_output_type: console
---

# yahew

This is my collection of tools for DNA methylation analysis.

### Install

```{r message = F, eval = F}
library(devtools)
install_github('wvictor14/yahew')
```

```{r, message = F, warning = F}
library(plyr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(minfiData)
library(yahew)
```

### lmmatrix

Computes pairwise linear models between several variables.

```{r message = F}
# load example data
data(RGsetEx)

# calculate pcs on the data
betas <- getBeta(RGsetEx)
pc_obj <- prcomp(t(na.omit(betas)), center = T, scale = T)
rotated <- pc_obj$x

#rsquared
rsq <- lmmatrix(dep = rotated,
                ind = as.data.frame(pData(RGsetEx)[,c('Sample_Group', 'age', 'sex', 'status')]))

#pvalue
pva <- lmmatrix(dep = rotated,
                ind = as.data.frame(pData(RGsetEx)[,c('Sample_Group', 'age', 'sex', 'status')]),
                metric = 'Pvalue')
##### plot
# reshape first
rsq_plot <- rsq %>% as.data.frame() %>% 
  
  # add dep variables
  mutate(dep = rownames(rsq)) %>%
  
  # reshape
  gather(PC, rsquared, -dep)

pva_plot <- pva %>% as.data.frame() %>% 
  
  # add dep variables
  mutate(dep = rownames(rsq)) %>%
  
  # reshape
  gather(PC, pval, -dep) %>%
  
  # pvalue categories
  mutate(pval_cat = case_when(
    pval > 0.05  ~ '> 0.05',
    pval < 0.05 & pval > 0.01 ~ '< 0.05',
    pval < 0.01 & pval > 0.001 ~ '< 0.01',
    pval < 0.001 ~ '< 0.001'
  ))
  
ggplot(rsq_plot, aes(x = PC, y = dep, fill = rsquared)) +
  geom_tile() + theme_bw() +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradientn(colours=c("white", "#ffffcc", "#41b6c4", "#2c7fb8", "#253494"), 
                       breaks = c(0,0.5,1), limits = c(0,1), 
                       guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")) 
ggplot(pva_plot, aes(x = PC, y = dep, fill = pval_cat)) +
  geom_tile() + theme_bw() +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_manual(values = c('> 0.05' = 'white', '< 0.05' = '#fee8c8', 
                               '< 0.01' = '#fdbb84', '< 0.001' = '#e34a33'))
```

### pairTest

To test if covariates are confounding each other, we need to pairwise tests of independence between
covariates. If at least one covariate is numeric, we can use linear regression. Otherwise if both
covariates are categorical, then a chi squared test must be used.

```{r}
variables <- data.frame(
  row = c(1, 1, 2, 2, 3, 3),
  column = c(1, 1, 1, 2, 2, 2),
  Sex = c('m', 'm', 'm', 'f', 'f', 'f'),
  age = c(18, 19, 18, 27, 30, 16),
  ethnicity = c('AF', 'AF', 'AF', 'EU', 'EU', 'AS')
)

tests <- pairtest(variables)
# make categories
tests <- tests %>% 
  mutate(pval_cat = if_else(p.value < 0.001, '< 0.001',
                            if_else(p.value < 0.01, '< 0.01',
                                    if_else(p.value < 0.05, '< 0.05', '<1'))))
tests

# plot heatmap of associations
ggplot(tests, aes(x=Row, y = Column, fill = pval_cat)) +
  geom_tile(col = 'grey') + theme(panel.background = element_blank()) + 
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_manual(values = c('> 0.05' = 'white', '< 0.05' = '#fee8c8', 
                               '< 0.01' = '#fdbb84', '< 0.001' = '#e34a33'))
```

### makeSampleSheet

`makeSampleSheet` takes a vector of sample IDs and queries the Robinson lab 'MASTER SS.xlsx' for associated idats. It returns chip/batch, filepath information along with some basic clinical variables that are available such as tissue type, GA and sex. The returned dataframe can be used to directly load in these idats into an `minfi::rgset`.

This function does not work unless connected to BCCHR network and cfrifs02 is mapped to Z:

```{r}
# Queried samples
samples <- c('PM4', 'PM30', 'PM47', 'PM123', 'PM130', 'PM306')
ss <- makeSampleSheet(samples)
ss
```

Notice we looked based on case ID, and what was returned contains files associated with that case (e.g. PM306 returned 'PM306r', 'PM306_d', 'PM306_v',...)

```{r}
rgset <- minfi::read.metharray.exp(targets = ss, verbose = T)
rgset
```
